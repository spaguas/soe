<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SP-Águas • Mapa</title>

  <script
    src="https://code.jquery.com/jquery-3.6.1.min.js"
    integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
    crossorigin="anonymous"></script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- IconLayers -->
  <script src="
  https://cdn.jsdelivr.net/npm/leaflet-iconlayers@0.2.0/dist/iconLayers.min.js
  "></script>
  <link href="
  https://cdn.jsdelivr.net/npm/leaflet-iconlayers@0.2.0/dist/iconLayers.min.css
  " rel="stylesheet">

  <!-- Dixie - IndexedDB -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.4/dist/dexie.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: fixed; inset: 0; width: 100vw; height: 94.4vh; top:56px; }
    .leaflet-container a { color: var(--bs-primary); }
    .leaflet-control .btn { line-height: 1; padding: .5rem .75rem; }
    .navbar-brand img { height: 32px; }

    .leaflet-touch .leaflet-control-layers, .leaflet-touch .leaflet-bar {
      border: none;
    }
  </style>
</head>
<!-- Loading params to filters -->
<script src="municipios.js"></script>
<script src="ugrhis.js"></script>
<script src="scripts/base_layers.js"></script>
<script src="scripts/iconlayer_control.js"></script>
<script src="scripts/watermark_control.js"></script>
<script src="scripts/filter_control.js"></script>


<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/logo-spaguas-colorido.png" alt="SP-Águas" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#">Início</a></li>
          <li class="nav-item"><a class="nav-link" href="#map">Mapa</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#offFilters">Filtros</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Relatórios</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Mais</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Configurações</a></li>
              <li><a class="dropdown-item" href="#">Ajuda</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#">Sair</a></li>
            </ul>
          </li>
        </ul>
        <!--<div class="d-flex">
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offFilters">Abrir Filtros</button>
        </div>-->
      </div>
    </div>
  </nav>

  <!-- MAPA FULLSCREEN -->
  <div id="map" role="region" aria-label="Mapa interativo"></div>

  <!-- OFFCANVAS: Controles e Filtros -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offFilters" aria-labelledby="offFiltersLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offFiltersLabel">Filtros</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
      <form id="filterForm" class="vstack gap-3">
        
        <div class="form-floating">
          <select id="ugrhis" class="form-select">              
          </select>
          <label for="es-field">Ugrhis</label>
        </div>

        <div class="form-floating">
          <select id="municipios" class="form-select">              
          </select>
          <label for="es-field">Municípios</label>
        </div>

        <div class="form-floating">
          <select id="tipo_uso" class="form-select">
              <option value="">-</option>
              <option value="Travessia Subterrânea">Travessia Subterrânea</option>
              <option value="Autorização para perfuração de Poço Tubular">Poço Tubular</option>
              <option value="Lançamento Superficial">Lançamento Superficial</option>
              <option value="Captação Subterrânea">Captação Subterrânea</option>
              <option value="Captação Superficial">Captação Superficial</option>
              <option value="Reservatório de Acumulação">Reservatório de Acumulação</option>
              <option value="Obra ou Serviço de Proteção de Margem ou Leito">Obra ou Serviço</option>
              <option value="Retificação / Revogação">Retificação / Revogação</option>
              <option value="Canalização">Canalização</option>
              <option value="Travessia Aérea">Travessia Aérea</option>
              <option value="Barramento">Barramento</option>
              <option value="Desassoreamento e Limpeza de Margem">Desassoreamento</option>
              <option value="Travessia">Travessia</option>
              <option value="Extração de Minério">Extração de Minério</option>
          </select>
          <label for="es-field">Tipo de Uso</label>
        </div>

        <div class="form-floating">
          <select name="tipo_finalidade_grupo" id="finalidade" class="form-select">
            <option value="">-</option>
            <option value="Urbano">Urbano</option>
            <option value="Irrigação">Irrigação</option>
            <option value="Industrial">Industrial</option>
            <option value="Doméstico">Doméstico</option>
            <option value="Aquicultura">Aquicultura</option>
            <option value="Outros">Outros</option>
            <option value="Comércio e Serviços">Comércio e Serviços</option>
            <option value="Recreação e Paisagismo">Recreação e Paisagismo</option>
            <option value="Regularização de Nível">Regularização de Nível</option>
            <option value="Regularização de Vazões">Regularização de Vazões</option>
            <option value="Mineração">Mineração</option>
            <option value="Rural">Rural</option>
            <option value="Controle de Cheias">Controle de Cheias</option>
            <option value="Geração de Energia">Geração de Energia</option>
          </select>
          <label for="es-field">Tipo de Finalidade</label>
        </div>
        
        <button type="button" id="btn-buscar" class="btn btn-success"><i class="bi bi-search"></i> Buscar</button>
      </form>
      <hr/>
      <div class="small text-secondary mb-2">Resultados</div>
      <div id="es-summary" class="small mb-2">—</div>
      <ul id="results" class="list-group small mb-3"></ul>
      <pre id="es-output" class="bg-light border rounded p-2 small" style="max-height: 260px; overflow:auto; white-space: pre-wrap;"></pre>
      <!-- Armazenamento local -->
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="small text-secondary">Armazenamento local (incremental)</span>
          <span id="ls-count" class="badge text-bg-secondary">0</span>
        </div>
        <div class="hstack gap-2">
          <button id="btn-ls-show" class="btn btn-outline-secondary btn-sm" type="button">Ver registros</button>
          <button id="btn-ls-clear" class="btn btn-outline-danger btn-sm" type="button">Limpar</button>
        </div>
        <pre id="ls-output" class="bg-light border rounded p-2 small mt-2 d-none" style="max-height: 180px; overflow:auto; white-space: pre-wrap;"></pre>
      </div>
    </div>
  </div>

  <script>
    const INITIAL_VIEW = { lat: -23.5505, lng: -46.6333, zoom: 10 };
    const map = L.map('map').setView([INITIAL_VIEW.lat, INITIAL_VIEW.lng], INITIAL_VIEW.zoom);
    
    //Load iconLayers control
    iconLayersControl.addTo(map);

    //Populate selects
    populateUgrhisSelect();
    populateMunicipiosSelect();
    
    //Load watermark
    map.addControl(new WatermarkControl());
    map.addControl(new FilterControl());

    var outorgas_soe = L.tileLayer.wms("https://geodados.daee.sp.gov.br/geoserver/geonode/wms", {
        layers: 'outorgas-soe',
        format: 'image/png',
        transparent: true,
        tiled: false,
        zIndex:100,
        tileSize: 256,
        attribution: "Data © 2023 Geodados",
        updateWhenZooming: true,
        updateWhenIdle: true,
        reuseTiles: true,
        detectRetina: true,
        maxZoom: 19,
        name: 'Outorgas SOE',
        keepBuffer: 4,
        enabled: true, // Custom property to track if layer is active
        CQL_FILTER: ""
    }).addTo(map); // Add the layer to the map

    document.getElementById('btn-buscar').onclick = function() {
      const form = document.getElementById('filterForm');
      const values = {
        tipo_uso:        getMultiValues(form.tipo_uso),
        municipios:      getMultiValues(form.municipios),
        ugrhis:          getMultiValues(form.ugrhis),
        tipo_finalidade: getMultiValues(form.finalidade)
      };
      const cql = buildCql(values);
      applyCqlToActiveLayers(cql);
      document.getElementById('es-output').textContent = cql || 'Sem filtro (todos os registros)';
    };

    function applyCqlToActiveLayers(cql) {
      $.each(map._layers, function(i, l) {
        console.log("Layer:", l);
        if (l.options.layers == "outorgas-soe") {
          l.setParams({ CQL_FILTER: cql || undefined });
          l.redraw();
        }
      });
    }

    function setLayerCql(layerName, cqlExpr) {
      const rec = map._layers.find(l => l.name === layerName);
      if (!rec) return;
      rec.cql = cqlExpr || '';
      if (rec.layerObj) {
        rec.layerObj.setParams({ CQL_FILTER: rec.cql });
      }
    }

    const sqlQuote = s => `'${String(s).replace(/'/g, "''")}'`;

    const ATTR = {
      tipo_uso:        'tipo_uso',
      municipios:      'cod_ibge',        // ex.: no dado pode ser 'municipio'
      ugrhis:          'ugrhi',
      tipo_finalidade: 'tipo_finalidade'   // evite espaços em nomes de atributos
    };

    const inList   = (field, values) =>
      values.length === 1
        ? `${field} = ${sqlQuote(values[0])}`
        : `${field} IN (${values.map(sqlQuote).join(',')})`;

    const andClause = parts => parts.filter(Boolean).join(' AND ');

    // Coleta valores selecionados de um <select multiple>
    function getMultiValues(sel) {
      return Array.from(sel.selectedOptions).map(o => o.value).filter(v => v !== '');
    }

    function buildCql({ tipo_uso=[], municipios=[], ugrhis=[], tipo_finalidade=[] }) {
      const clauses = [];

      if (tipo_uso.length)        clauses.push(inList(ATTR.tipo_uso,        tipo_uso));
      if (municipios.length)      clauses.push(inList(ATTR.municipios,      municipios));
      if (ugrhis.length)          clauses.push(inList(ATTR.ugrhis,          ugrhis));
      if (tipo_finalidade.length) clauses.push(inList(ATTR.tipo_finalidade, tipo_finalidade));

      return andClause(clauses) || null; // null => sem filtro
    }

    function populateUgrhisSelect(){
      $("#ugrhis").empty();
      $("#ugrhis").append("<option value=''>-</option>");
      $.each(ugrhis.ugrhis, function(k,v){
        let obj = "<option value='"+v.codigo+"'>"+v.nome+"</option>";
        //console.log(obj);
        if(v.codigo != 99 && v.codigo != 9999){
          $("#ugrhis").append(obj);
        }
      });
    }

    function populateMunicipiosSelect(){
      $("#municipios").empty();

      $("#municipios").append("<option value=''>-</option>");
      $.each(municipios.municipios, function(k,v){
        
        let obj = "<option value='"+v.codigo_ibge +"'>"+v.nome+"</option>";
        //console.log(obj);
        $("#municipios").append(obj);
      });
    }

  </script>